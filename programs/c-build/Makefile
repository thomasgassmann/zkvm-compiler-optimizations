CC=$(ZK_CLANG_PATH)
OPT=$(ZK_OPT_PATH)
LLC=$(ZK_LLC_PATH)
CFLAGS=$(ZK_TARGET_CFLAGS) $(ZK_CFLAGS) -Xclang -disable-O0-optnone -I../c-platform/include -Wno-incompatible-library-redeclaration
LLVMFLAGS=-disable-verify -passes='$(PASSES)' $(ZK_LLVMFLAGS)

LIBNAME=lib$(PROGRAM).a

define add 
	$(CC) $(CFLAGS) -S -emit-llvm ${2} -o $(OUTDIR)/${1}.ll
	$(OPT) $(LLVMFLAGS) -S $(OUTDIR)/${1}.ll -o $(OUTDIR)/${1}opt.ll
	$(LLC) $(LLC_FLAGS) -filetype=obj $(OUTDIR)/${1}opt.ll -o $(OUTDIR)/${1}.o
endef

define archive
	ar rcs $(OUTDIR)/$(LIBNAME) ${1} ${2} ${3} ${4} ${5} ${6} ${7} ${8} ${9} ${10} ${11} ${12} ${13} ${14} ${15} ${16} ${17} ${18} ${19} ${20}
endef

.PHONY: setup
setup:
	@mkdir -p $(OUTDIR)

.PHONY: all
all: setup $(OUTDIR)/$(LIBNAME)

.PHONY: clean
clean:
	rm -rf $(OUTDIR)
